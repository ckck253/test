<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Coding Class Login</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Fira+Code&family=Roboto:wght@400;700&display=swap');
  :root {
    --bg-dark: #0f172a;
    --bg-light: #f0f4f8;
    --text-dark: #cbd5e1;
    --text-light: #111827;
    --primary: #38bdf8;
    --primary-dark: #0284c7;
    --error: #ef4444;
    --success: #22c55e;
  }
  body {
    margin: 0;
    font-family: 'Roboto', sans-serif;
    background-color: var(--bg-dark);
    color: var(--text-dark);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1rem;
    transition: background-color 0.3s, color 0.3s;
  }
  body.light {
    background-color: var(--bg-light);
    color: var(--text-light);
  }
  .container {
    background-color: var(--bg-dark);
    padding: 2rem 2.5rem;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(100,116,139,0.6);
    width: 100%;
    max-width: 420px;
    transition: background-color 0.3s;
  }
  body.light .container {
    background-color: var(--bg-light);
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
  }
  h1 {
    font-family: 'Fira Code', monospace;
    text-align: center;
    margin-bottom: 1rem;
    color: var(--primary);
    text-shadow: 0 0 8px var(--primary);
  }
  label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: 600;
    font-family: 'Fira Code', monospace;
    color: inherit;
  }
  input[type=text],
  input[type=password] {
    width: 100%;
    padding: 0.75rem 1rem;
    margin-bottom: 1.25rem;
    border-radius: 8px;
    border: none;
    font-family: 'Fira Code', monospace;
    font-size: 1rem;
    background: #1e293b;
    color: var(--text-dark);
    box-shadow: inset 0 0 8px #0f172a;
    transition: background-color 0.3s, color 0.3s;
  }
  body.light input[type=text],
  body.light input[type=password] {
    background: #fff;
    color: var(--text-light);
    box-shadow: inset 0 0 5px #ccc;
  }
  input[type=text]:focus,
  input[type=password]:focus {
    outline: none;
    box-shadow: 0 0 12px var(--primary);
    background: #152238;
    color: var(--text-dark);
  }
  body.light input[type=text]:focus,
  body.light input[type=password]:focus {
    background: #e2e8f0;
    color: var(--text-light);
  }
  button {
    width: 100%;
    padding: 0.85rem 0;
    border: none;
    border-radius: 10px;
    background: var(--primary);
    color: var(--bg-dark);
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    letter-spacing: 0.05em;
    font-family: 'Fira Code', monospace;
    transition: background-color 0.3s ease;
    user-select: none;
    box-shadow: 0 4px 12px var(--primary);
  }
  button:hover {
    background: var(--primary-dark);
    color: #e0f2fe;
  }
  #error-msg {
    color: var(--error);
    text-align: center;
    margin-bottom: 1rem;
    font-weight: 700;
    user-select: none;
  }
  #success-msg {
    color: var(--success);
    text-align: center;
    margin-bottom: 1rem;
    font-weight: 700;
    user-select: none;
  }
  #dashboard, #admin-panel {
    display: none;
  }
  .welcome {
    text-align: center;
    font-family: 'Fira Code', monospace;
    margin-bottom: 1rem;
    color: var(--primary);
    font-size: 1.3rem;
    text-shadow: 0 0 10px var(--primary);
    user-select: none;
  }
  .info {
    text-align: center;
    font-style: italic;
    color: #64748b;
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
    user-select: none;
  }
  .log {
    background: #1e293b;
    border-radius: 8px;
    padding: 15px;
    max-height: 160px;
    overflow-y: auto;
    font-family: 'Fira Code', monospace;
    font-size: 0.85rem;
    color: #94a3b8;
    margin-bottom: 1rem;
    user-select: text;
  }
  body.light .log {
    background: #f1f5f9;
    color: #475569;
  }
  .btn-logout {
    background: #ef4444;
    color: white;
    font-weight: 700;
    letter-spacing: 0.1em;
    box-shadow: 0 4px 12px #f87171;
  }
  .btn-logout:hover {
    background: #dc2626;
  }
  .btn-zoom {
    background: #22c55e;
    box-shadow: 0 4px 12px #22c55e;
  }
  .btn-zoom:hover {
    background: #16a34a;
  }
  .btn-add-student {
    background: #6366f1;
    box-shadow: 0 4px 12px #6366f1;
  }
  .btn-add-student:hover {
    background: #4f46e5;
  }
  .form-inline {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  .form-inline input[type=text], .form-inline input[type=password] {
    flex: 1;
    margin-bottom: 0;
  }
  .theme-toggle {
    cursor: pointer;
    user-select: none;
    text-align: center;
    margin-top: 1rem;
    font-family: 'Fira Code', monospace;
    font-weight: 600;
    color: var(--primary);
    text-shadow: 0 0 5px var(--primary);
  }
  .theme-toggle:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<div class="container" id="login-container">
  <h1>Coding Class</h1>
  <label for="username">Username</label>
  <input type="text" id="username" autocomplete="off" placeholder="Enter username" />
  <label for="password">Password</label>
  <input type="password" id="password" autocomplete="off" placeholder="Enter password" />
  <button onclick="login()">Login</button>
  <div id="error-msg"></div>
  <div class="theme-toggle" onclick="toggleTheme()">Toggle Dark/Light Theme</div>
</div>

<div class="container" id="dashboard">
  <div class="welcome">Welcome, <span id="user-display"></span>!</div>
  <div class="info">Class every Monday at 8:30 PM Lebanon / 6:30 PM UK</div>
  <button class="btn-zoom" onclick="joinClass()">Join Zoom Class</button>
  <div id="success-msg"></div>
  <div class="log" id="attendance-log"></div>
  <button class="btn-logout" onclick="logout()">Logout</button>
</div>

<div class="container" id="admin-panel">
  <h1>Admin Panel</h1>
  <button class="btn-zoom" onclick="joinClass()">Join Zoom Class</button>

  <h3>Attendance Log</h3>
  <div class="log" id="admin-attendance-log">Loading attendance...</div>

  <h3>Add Student</h3>
  <div class="form-inline">
    <input type="text" id="new-username" placeholder="New student username" autocomplete="off" />
    <input type="password" id="new-password" placeholder="New student password" autocomplete="off" />
    <button class="btn-add-student" onclick="addStudent()">Add</button>
  </div>

  <div id="admin-msg"></div>
  <button class="btn-logout" onclick="logout()">Logout</button>
</div>

<script>
  const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxse2UcqSToVnn7iY-rQ-BBsc2vFvRvhp6OyixK-dSclwgcpDG23SD8L600F4f3QzD_/exec";

  let currentUser = null;
  let currentRole = null;

  function toggleTheme() {
    document.body.classList.toggle("light");
  }

  async function login() {
    const username = document.getElementById("username").value.trim().toLowerCase();
    const password = document.getElementById("password").value.trim();
    const errorMsg = document.getElementById("error-msg");
    errorMsg.textContent = "";

    if (!username || !password) {
      errorMsg.textContent = "Please enter username and password.";
      return;
    }

    try {
      const resp = await fetch(BACKEND_URL, {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: new URLSearchParams({
          action: "login",
          username: username,
          password: password,
        }),
      });
      const data = await resp.json();

      if (data.status === "success") {
        currentUser = username;
        currentRole = data.role;
        showDashboard();
      } else {
        errorMsg.textContent = data.message || "Login failed.";
      }
    } catch (e) {
      errorMsg.textContent = "Error connecting to server.";
    }
  }

  function showDashboard() {
    document.getElementById("login-container").style.display = "none";
    if (currentRole === "student") {
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("user-display").textContent = currentUser;
      logAttendance(); // Automatically log attendance on login
    } else if (currentRole === "admin") {
      document.getElementById("admin-panel").style.display = "block";
      document.getElementById("user-display").textContent = currentUser;
      loadAttendance();
    }
  }

  async function logAttendance() {
    const successMsg = document.getElementById("success-msg");
    const attendanceLog = document.getElementById("attendance-log");
    successMsg.textContent = "";
    attendanceLog.innerHTML = "";

    try {
      const resp = await fetch(BACKEND_URL, {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: new URLSearchParams({
          action: "join",
          username: currentUser,
        }),
      });
      const data = await resp.json();

      if (data.status === "success") {
        successMsg.textContent = "Attendance logged successfully.";
        attendanceLog.innerHTML = `<p>Attendance time: ${new Date(data.timestamp).toLocaleString()}</p>`;
      } else {
        successMsg.textContent = "Failed to log attendance.";
      }
    } catch (e) {
      successMsg.textContent = "Error connecting to server.";
    }
  }

  async function joinClass() {
    try {
      const resp = await fetch(BACKEND_URL, {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: new URLSearchParams({
          action: "join",
          username: currentUser,
        }),
      });
      const data = await resp.json();

      if (data.status === "success") {
        window.open(data.zoomLink, "_blank");
      } else {
        alert("Could not get Zoom link.");
      }
    } catch {
      alert("Error connecting to server.");
    }
  }

  async function loadAttendance() {
    const adminLog = document.getElementById("admin-attendance-log");
    const adminMsg = document.getElementById("admin-msg");
    adminLog.textContent = "Loading attendance...";
    adminMsg.textContent = "";

    try {
      const resp = await fetch(BACKEND_URL, {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: new URLSearchParams({
          action: "getAttendance",
          adminUser: currentUser,
          adminPass: prompt("Please enter admin password:"),
        }),
      });
      const data = await resp.json();

      if (data.status === "success") {
        if (data.attendance.length === 0) {
          adminLog.textContent = "No attendance records found.";
          return;
        }
        let html = "<ul>";
        data.attendance.forEach(rec => {
          const dt = new Date(rec.timestamp).toLocaleString();
          html += `<li><strong>${rec.username}</strong> - ${dt}</li>`;
        });
        html += "</ul>";
        adminLog.innerHTML = html;
      } else {
        adminLog.textContent = "Failed to load attendance.";
        adminMsg.textContent = data.message || "";
      }
    } catch (e) {
      adminLog.textContent = "Error connecting to server.";
    }
  }

  async function addStudent() {
    const newUser = document.getElementById("new-username").value.trim().toLowerCase();
    const newPass = document.getElementById("new-password").value.trim();
    const adminMsg = document.getElementById("admin-msg");
    adminMsg.textContent = "";

    if (!newUser || !newPass) {
      adminMsg.textContent = "Please enter new student's username and password.";
      return;
    }

    try {
      const resp = await fetch(BACKEND_URL, {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: new URLSearchParams({
          action: "addStudent",
          adminUser: currentUser,
          adminPass: prompt("Please enter admin password:"),
          newUser: newUser,
          newPass: newPass,
        }),
      });
      const data = await resp.json();

      if (data.status === "success") {
        adminMsg.style.color = "green";
        adminMsg.textContent = "New student added successfully!";
        document.getElementById("new-username").value = "";
        document.getElementById("new-password").value = "";
        loadAttendance(); // refresh attendance list
      } else {
        adminMsg.style.color = "red";
        adminMsg.textContent = data.message || "Failed to add student.";
      }
    } catch (e) {
      adminMsg.style.color = "red";
      adminMsg.textContent = "Error connecting to server.";
    }
  }

  function logout() {
    currentUser = null;
    currentRole = null;
    document.getElementById("username").value = "";
    document.getElementById("password").value = "";
    document.getElementById("login-container").style.display = "block";
    document.getElementById("dashboard").style.display = "none";
    document.getElementById("admin-panel").style.display = "none";
    document.getElementById("error-msg").textContent = "";
    document.getElementById("success-msg").textContent = "";
    document.getElementById("attendance-log").innerHTML = "";
    document.getElementById("admin-attendance-log").innerHTML = "";
    document.getElementById("admin-msg").textContent = "";
  }
</script>

</body>
</html>
